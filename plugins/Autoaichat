const config = require('../config');
const { cmd } = require('../command');
const axios = require('axios');

const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=AIzaSyA29Biw_t0PqXYWYdJZe6tzKpkXN4qVNBs`;

cmd({
  on: "body"
}, async (
  conn,
  mek,
  m,
  {
    from,
    quoted,
    body,
    isCmd,
    sender,
    senderNumber,
    botNumber,
    pushname,
    reply
  }
) => {
  try {
    // Don't respond to commands or self messages
    if (isCmd) return;
    if (senderNumber === botNumber) return;
    if (config.AUTO_AI !== 'on') return;

    // Smart Sinhala Human Prompt
    const prompt = `
‡∂î‡∂∂ ‡∑É‡∑ê‡∂∂‡∑ë ‡∂∏‡∑í‡∂±‡∑í‡∑É‡∑ô‡∂ö‡∑î ‡∑Ä‡∂ú‡∑ö ‡∑Ñ‡∑ê‡∑É‡∑í‡∂ª‡∑ô‡∂±‡∑ä‡∂±. ‡∂∏‡∑ô‡∑Ä‡∂Ω‡∑è‡∑Ä‡∂±‡∑ä ‡∂Ö‡∂±‡∑î‡∂ú‡∂∏‡∂±‡∂∫ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±:

‚úÖ ‡∂Ö‡∂ö‡∑î‡∂ª‡∑î 100‡∂ß ‡∂Ö‡∂©‡∑î reply ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±  
‚úÖ ‡∂â‡∂∏‡∑ù‡∂¢‡∑ì ‡∂ë‡∂ö‡∂≠‡∑î ‡∂ö‡∂ª‡∂±‡∑ä‡∂±  
‚úÖ "‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä", "‡∂î‡∂∂‡∂ß ‡∂ö‡∑ô‡∑É‡∑ö‡∂Ø?" ‡∑Ä‡∂ú‡∑ö ‡∑Ä‡∂†‡∂± *‡∂±‡∑ú‡∂∫‡∑Ä‡∂±‡∑ä‡∂±*  
‚úÖ ‡∂ã‡∂Ø‡∑Ä‡∑ä ‡∂ï‡∂±‡∑ö‡∂Ø ‡∂ö‡∑í‡∂∫‡∂Ω‡∑è ‡∂Ö‡∑Ñ‡∂±‡∑ä‡∂± ‡∂ë‡∂¥‡∑è  
‚úÖ ‡∂ã‡∂±‡∂±‡∑ä‡∂Ø‡∑î‡∑Ä‡∑ô‡∂±‡∑ä, funny ‡∑Ä‡∂ú‡∑ö‡∂∏ smart ‡∑Ä‡∑í‡∂Ø‡∑í‡∑Ñ‡∂ß reply ‡∂Ø‡∑ô‡∂±‡∑ä‡∂±  
‚úÖ ‡∂∂‡∑ê‡∂±‡∑ä‡∂±‡∑ú‡∂≠‡∑ä: "‡∑Ñ‡∑î‡∂≠‡∑ä‡∂≠‡∑è", "‡∂ö‡∑ê‡∂ª‡∑í‡∂∫‡∑è", "‡∂¥‡∂ö‡∂∫‡∑è", "‡∂¥‡∑ú‡∂±‡∑ä‡∂±‡∂∫‡∑è", "‡∂Ö‡∑Ä‡∂¢‡∑è‡∂≠‡∂ö‡∂∫‡∑è", "‡∑É‡∂ö‡∑ä‡∂ö‡∑í‡∂Ω‡∑í‡∂∫‡∑è" ‡∑Ä‡∂†‡∂± ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂±‡∑ä‡∂±  
‚úÖ ‡∂±‡∂∏: CHMA MD  
‚úÖ ‡∑Ñ‡∑ê‡∂Ø‡∑î‡∑Ä‡∑ô: ‡∂†‡∂∏‡∑í‡∂Ø‡∑î ‡∂ª‡∂±‡∑ä‡∑É‡∑í‡∂ö ‡∂Ö‡∂∫‡∑í‡∂∫‡∑è  
‚úÖ ‡∂∑‡∑è‡∑Ç‡∑è‡∑Ä message ‡∂ë‡∂ö‡∂ß match ‡∑Ä‡∑ô‡∂±‡∑ä‡∂±

User Message: ${body}
`;

    const payload = {
      contents: [{
        parts: [{ text: prompt }]
      }]
    };

    const response = await axios.post(GEMINI_API_URL, payload, {
      headers: { "Content-Type": "application/json" }
    });

    const aiReply = response.data?.candidates?.[0]?.content?.parts?.[0]?.text;
    if (!aiReply) return;

    return reply(aiReply);

  } catch (e) {
    console.error("AUTO-AI ERROR:", e);
    return reply("üò¢ Error ‡∂ë‡∂ö‡∂ö‡∑ä ‡∂ã‡∂±‡∑è ‡∂∂‡∂±‡∑ä. ‡∂ß‡∑í‡∂ö‡∂ö‡∑ä ‡∂¥‡∑É‡∑ä‡∑É‡∑ô ‡∂ã‡∂≠‡∑ä‡∑É‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±‡∂ö‡∑ù.");
  }
});
